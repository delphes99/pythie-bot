<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" lang="fr">
<head>
	<link rel="stylesheet" href="overlay.css"/>
	<script src="https://unpkg.com/vue@next"></script>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<title>Overlay</title>
</head>
<body>
<div id="overlay">
	<!-- <alert :data="alert"></alert> -->
	<div id="footer">
		<event-list
				v-for="item in events"
				:key="item.type"
				:last_events="item.events"
				:type="item.type"
				:id="item.type.name">
		</event-list>
	</div>
</div>
</body>
</html>

<script type="application/javascript">
	const LAST_FOLLOW = {name: "last_follows", img: "img/follow.png"};
	const LAST_SUB = {name: "last_subs", img: "img/sub.png"};
	const LAST_CHEER = {name: "last_cheers", img: "img/cheer.png"};
	const LAST_VOTH = {name: "last_voths", img: "img/voth.png"};

	function emptyEventsFor(type) {
		return {
			type: type,
			events: []
		}
	}

	const Overlay = {
		data() {
			return {
				events: [
					emptyEventsFor(LAST_FOLLOW),
					emptyEventsFor(LAST_SUB),
					emptyEventsFor(LAST_CHEER),
					emptyEventsFor(LAST_VOTH)
				],
				alert: {"type": "test", "parameters": {}}
			}
		},
		methods: {
			load() {
				axios.get('http://localhost:8080/delphes99/overlay/infos')
						.then(response => {
							const data = response.data;
							this.events = [
								{
									type: LAST_FOLLOW,
									events: data.last_follows.map(follow => {
										return {user: follow}
									})
								},
								{
									type: LAST_SUB,
									events: data.last_subs.map(sub => {
										return {user: sub}
									})
								},
								{
									type: LAST_CHEER,
									events: data.last_cheers.map(({user, bits}) => {
										return {user: user, infos: bits}
									})
								},
								{
									type: LAST_VOTH,
									events: data.last_voths.map(voth => {
										return {user: voth}
									})
								}
							]
						})
						.catch(error => console.error(error));
			}
		},
		mounted: function () {
			this.load();
		}
	}

	let app = Vue.createApp(Overlay);
	app.component('event-list', {
		props: ['last_events', 'type'],
		template: `
			<div class="event-list">
				<img :src="type.img"/>
				<div class="first" v-if="last_events[0]">
					<div>{{ last_events[0].user }}</div>
					<div class="infos" v-if="last_events[0].infos">{{ last_events[0].infos }}</div>
				</div>
				<div class="second" v-if="last_events[1]">
					<div>{{ last_events[1].user }}</div>
					<div class="infos" v-if="last_events[1].infos">{{ last_events[1].infos }}</div>
				</div>
				<div class="third" v-if="last_events[2]">
					<div>{{ last_events[2].user }}</div>
					<div class="infos" v-if="last_events[2].infos">{{ last_events[2].infos }}</div>
				</div>
			</div>`
	});
	app.component('alert', {
		props: ['data'],
		computed: {
			alertText: function () {
				if (this.data) {
					console.log(this.data)
					if (this.data.type === "newVip") {
						return "Nouveau VIP : " + this.data.parameters["newVIP"]
					} else if (this.data.type === "test") {
						return "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam dictum ut ante id fringilla. Morbi hendrerit in sem quis rhoncus. Quisque in interdum ipsum, vel aliquet nulla. Nam sagittis massa mauris, a venenatis eros auctor vel. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Duis egestas, orci et auctor mattis, purus ipsum ultricies augue, vitae blandit ipsum lorem id felis. Vivamus nulla purus, aliquet vel fermentum sit amet, cursus in felis. Nulla nec varius mauris, eu facilisis libero. Donec dictum porta posuere. Pellentesque viverra enim vel vehicula rhoncus. Aenean elit enim, vehicula id mollis in, imperdiet id leo. Mauris tincidunt nisi rutrum sagittis ultricies. Ut sagittis lacus eu orci sodales rhoncus. Integer aliquet tellus tellus, eget volutpat justo ullamcorper eget. Quisque non accumsan nisi."
					}
				}
			},
			img: function () {
				if (this.data) {
					return "img/voth.png"
				}
			},
			title: function () {
				if (this.data) {
					return "Nouveau VIP"
				}
			}
		},
		template: `
			<div class="alert">
				<div class="alert-title">
					<img :src="img"/>
					{{ title }}
				</div>
				<div class="alert-content">
					{{ alertText }}
				</div>
			</div>`
	})

	let vm = app.mount('#overlay')
	setInterval(() => {
		vm.load()
	}, 1000);

	let socket = new WebSocket("ws://localhost:8080/delphes99");

	socket.onopen = function () {
		this.onmessage = function (event) {
			vm.alert = JSON.parse(event.data)
			setTimeout(() => vm.alert = null, 3000)
		};
	};
</script>