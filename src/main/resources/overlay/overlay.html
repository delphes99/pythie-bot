<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" lang="fr">
<head>
	<link rel="stylesheet" href="overlay.css" />
	<script src="https://unpkg.com/vue@next"></script>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<title>Overlay</title>
</head>
<body>
<div id="overlay">
	<div class="alert">
		{{ alert }}
	</div>
	<div id="footer">
		<event-list
			v-for="item in events"
			:key="item.type"
			:last_events="item.events"
			:type="item.type"
			:id="item.type.name"/>
	</div>
</div>
</body>
</html>

<script type="application/javascript">
	const LAST_FOLLOW = { name:"last_follow", img:"img/follow.jpg" };
	const LAST_SUB = { name: "last_sub", img: "img/sub.jpg" };
	const LAST_CHEER = { name:"last_cheer", img:"img/cheer.jpg" };
	const LAST_VOTH = { name:"last_voth", img:"img/voth.jpg" };

	function emptyEventsFor(type) {
		return {
			type: type,
			events: []
		}
	}

	const Overlay = {
		data() {
			return {
				events: [
					emptyEventsFor(LAST_FOLLOW),
					emptyEventsFor(LAST_SUB),
					emptyEventsFor(LAST_CHEER),
					emptyEventsFor(LAST_VOTH)
				],
				alert: null
			}
		},
		methods: {
			load() {
				axios.get('http://localhost:8080/delphes99/overlay/infos')
						.then(response => {
							const data = response.data;
							this.events = [
								{
									type: LAST_FOLLOW,
									events: data.last_follow
								},
								emptyEventsFor(LAST_SUB),
								emptyEventsFor(LAST_CHEER),
								{
									type: LAST_VOTH,
									events: data.last_voth
								}
							]
						})
						.catch(error => console.error(error));
			}
		},
		mounted: function () {
			this.load();
		}
	}

	let app = Vue.createApp(Overlay);
	app.component('event-list', {
		props: ['last_events', 'type'],
		template: `<div class="event-list">
					<img :src="type.img" />
					<div class="first">{{ last_events[0] }}</div>
					<div class="second">{{ last_events[1] }}</div>
					<div class="third">{{ last_events[2] }}</div>
					</div>`
	})
	let vm = app.mount('#overlay')
	setInterval(() => {
		vm.load()
	}, 1000);


	let socket = new WebSocket("ws://localhost:8080/delphes99");

	socket.onopen = function() {
		this.onmessage = function(event) {
			vm.alert = event.data
			setTimeout(() => { vm.alert = null }, 3000)
		};
	};
</script>